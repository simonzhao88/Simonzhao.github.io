{"title":"在Djnago当中restful风格的实现","slug":"在djnago当中restful风格的实现","date":"2018-05-18T05:31:15.000Z","updated":"2018-07-14T08:44:38.217Z","comments":true,"path":"api/articles/在djnago当中restful风格的实现.json","photos":[],"link":"","excerpt":null,"covers":["/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_render_setting.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_render1.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_render2.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_error.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_filed_blank.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_fields_blank_youhua.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_framework.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_serializers.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_html_ajax_get.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_ajax_delete_function.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_keng1.png","/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_setting_keng1.png"],"content":"<h4 id=\"1-修改响应的结构\"><a href=\"#1-修改响应的结构\" class=\"headerlink\" title=\"1. 修改响应的结构\"></a>1. 修改响应的结构</h4><h5 id=\"1-1-修改settings-py中的返回数据结构的配置信息\"><a href=\"#1-1-修改settings-py中的返回数据结构的配置信息\" class=\"headerlink\" title=\"1.1 修改settings.py中的返回数据结构的配置信息\"></a>1.1 修改settings.py中的返回数据结构的配置信息</h5><p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_render_setting.png\" alt=\"图\"></p>\n<p>注意：定义default_renderer_classes参数，指定render的时候使用我们自定义的CustomJsonRender的类方法</p>\n<h5 id=\"1-2-重构JSONRenderer下的render方法\"><a href=\"#1-2-重构JSONRenderer下的render方法\" class=\"headerlink\" title=\"1.2 重构JSONRenderer下的render方法\"></a>1.2 重构JSONRenderer下的render方法</h5><p>该方法继承了JSONRenderer并且重构了render方法，修改了返回的数据结构</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_render1.png\" alt=\"图\"></p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_render2.png\" alt=\"图\"></p>\n<h4 id=\"2-异常的响应的结构\"><a href=\"#2-异常的响应的结构\" class=\"headerlink\" title=\"2. 异常的响应的结构\"></a>2. 异常的响应的结构</h4><p>自定义异常处理，一定需要继承from rest_framework.exceptions import APIException 中的APIException，在编写自己的异常处理的方法</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_error.png\" alt=\"图\"></p>\n<h4 id=\"3-PATCH请求，传入空置处理\"><a href=\"#3-PATCH请求，传入空置处理\" class=\"headerlink\" title=\"3. PATCH请求，传入空置处理\"></a>3. PATCH请求，传入空置处理</h4><h5 id=\"3-1-空置处理\"><a href=\"#3-1-空置处理\" class=\"headerlink\" title=\"3.1 空置处理\"></a>3.1 空置处理</h5><p>该patch请求中，我们想要修改id为3的学生的姓名，但是姓名我们传递一个空置，查看返回结果如下:</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_filed_blank.png\" alt=\"图\"></p>\n<h5 id=\"3-2-修改\"><a href=\"#3-2-修改\" class=\"headerlink\" title=\"3.2 修改\"></a>3.2 修改</h5><p>在serializer中定义s_name的序列化，指定错误的信息，为空的话，提示响应的错误信息</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_fields_blank_youhua.png\" alt=\"图\"></p>\n<hr>\n<h4 id=\"4-页面异步提交api接口请求，并且在前端通过js刷新页面\"><a href=\"#4-页面异步提交api接口请求，并且在前端通过js刷新页面\" class=\"headerlink\" title=\"4. 页面异步提交api接口请求，并且在前端通过js刷新页面\"></a>4. 页面异步提交api接口请求，并且在前端通过js刷新页面</h4><h5 id=\"4-1-创建实例\"><a href=\"#4-1-创建实例\" class=\"headerlink\" title=\"4.1. 创建实例\"></a>4.1. 创建实例</h5><h6 id=\"4-1-1-后端业务逻辑处理\"><a href=\"#4-1-1-后端业务逻辑处理\" class=\"headerlink\" title=\"4.1.1 后端业务逻辑处理\"></a>4.1.1 后端业务逻辑处理</h6><p>创建url，定义register，创建serializer_class等</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_framework.png\" alt=\"图\"></p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_serializers.png\" alt=\"图\"></p>\n<h5 id=\"4-2-前端ajax请求get获取数据并刷新\"><a href=\"#4-2-前端ajax请求get获取数据并刷新\" class=\"headerlink\" title=\"4.2 前端ajax请求get获取数据并刷新\"></a>4.2 前端ajax请求get获取数据并刷新</h5><h5 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_html_ajax_get.png\" alt=\"图\"></h5><h5 id=\"4-3-前端ajax请求delete删除数据\"><a href=\"#4-3-前端ajax请求delete删除数据\" class=\"headerlink\" title=\"4.3 前端ajax请求delete删除数据\"></a>4.3 前端ajax请求delete删除数据</h5><p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_ajax_delete.png\" alt=\"图\"></p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_ajax_delete_function.png\" alt=\"图\"></p>\n<h5 id=\"4-4-直接放入ajax更新删除获取信息的代码\"><a href=\"#4-4-直接放入ajax更新删除获取信息的代码\" class=\"headerlink\" title=\"4.4 直接放入ajax更新删除获取信息的代码\"></a>4.4 直接放入ajax更新删除获取信息的代码</h5><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class=\"line\">&lt;title&gt;展示所有学生的信息&lt;/title&gt;</span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot; src=&quot;/static/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">    $(function()&#123;</span><br><span class=\"line\">        $(&apos;#showStus&apos;).click(function()&#123;</span><br><span class=\"line\">            $.get(&apos;/stu/student/&apos;, function(msg)&#123;</span><br><span class=\"line\">                s = &apos;&lt;table&gt;&lt;tr&gt;&lt;td&gt;ID&lt;/td&gt;&lt;td&gt;姓名&lt;/td&gt;&lt;td&gt;地址&lt;/td&gt;&lt;td&gt;操作&lt;/td&gt;&lt;/tr&gt;&apos;</span><br><span class=\"line\">                for(var i=0; i&lt;msg.length; i++)&#123;</span><br><span class=\"line\">                    s += &apos;&lt;tr&gt;&lt;td&gt;&apos; + msg[i].id + &apos;&lt;/td&gt;\\</span><br><span class=\"line\">                    &lt;td&gt;&apos; + msg[i].s_name + &apos;&lt;/td&gt;\\</span><br><span class=\"line\">                    &lt;td&gt;&apos; + msg[i].s_tel + &apos;&lt;/td&gt;&lt;td&gt;\\</span><br><span class=\"line\">                    &lt;a href=&quot;javascript:;&quot; onclick=&quot;stu_update(&apos; + msg[i].id + &apos;)&quot;&gt;编辑&lt;/a&gt;|\\</span><br><span class=\"line\">                    &lt;a href=&quot;javascript:;&quot; onclick=&quot;del_stu(&apos; + msg[i].id + &apos;)&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&apos;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                s += &apos;&lt;/table&gt;&apos;</span><br><span class=\"line\">                $(&apos;#div_stus&apos;).html(s)</span><br><span class=\"line\">            &#125;, &apos;json&apos;);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    function del_stu(i)&#123;</span><br><span class=\"line\">        csrf = $(&apos;input[name=&quot;csrfmiddlewaretoken&quot;]&apos;).val()</span><br><span class=\"line\">        $.ajax(&#123;</span><br><span class=\"line\">            url:&apos;/stu/student/&apos; + i,</span><br><span class=\"line\">            type:&apos;DELETE&apos;,</span><br><span class=\"line\">            headers:&#123;&apos;X-CSRFToken&apos;: csrf&#125;,</span><br><span class=\"line\">            dataType:&apos;json&apos;,</span><br><span class=\"line\">            success: function(msg)&#123;</span><br><span class=\"line\">                alert(&apos;删除成功&apos;);</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            error: function(msg)&#123;</span><br><span class=\"line\">                console.log(msg)</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    function stu_update(i)&#123;</span><br><span class=\"line\">        s = &apos;ID: &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;&apos; + i + &apos;&quot;&gt;\\</span><br><span class=\"line\">        姓名:&lt;input type=&quot;text&quot; name=&quot;s_name&quot; id=&quot;s_name&quot;&gt; \\</span><br><span class=\"line\">        电话：&lt;input type=&quot;text&quot; name=&quot;s_tel&quot; id=&quot;s_tel&quot;&gt;\\</span><br><span class=\"line\">        &lt;input type=&quot;button&quot; value=&quot;提交&quot; onclick=&quot;update(&apos; + i + &apos;)&quot;&gt;&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">        $(&apos;#div_add&apos;).html(s)</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    function stu_add()&#123;</span><br><span class=\"line\">        s = &apos;姓名:&lt;input type=&quot;text&quot; name=&quot;s_name&quot; id=&quot;s_name&quot;&gt; \\</span><br><span class=\"line\">        电话：&lt;input type=&quot;text&quot; name=&quot;s_tel&quot; id=&quot;s_tel&quot;&gt;\\</span><br><span class=\"line\">        &lt;input type=&quot;button&quot; value=&quot;提交&quot; onclick=&quot;add()&quot;&gt;&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">        $(&apos;#div_add&apos;).html(s)</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">function update(i)&#123;</span><br><span class=\"line\">    csrf = $(&apos;input[name=&quot;csrfmiddlewaretoken&quot;]&apos;).val()</span><br><span class=\"line\">    s_name = $(&apos;#s_name&apos;).val()</span><br><span class=\"line\">    s_tel = $(&apos;#s_tel&apos;).val()</span><br><span class=\"line\">    $.ajax(&#123;</span><br><span class=\"line\">        url: &apos;/stu/student/&apos; + i + &apos;/&apos;,</span><br><span class=\"line\">        type: &apos;PATCH&apos;,</span><br><span class=\"line\">        dataType: &apos;json&apos;,</span><br><span class=\"line\">        headers:&#123;&apos;X-CSRFToken&apos;: csrf&#125;,</span><br><span class=\"line\">        data:&#123;&apos;s_name&apos;:s_name, &apos;s_tel&apos;:s_tel&#125;,</span><br><span class=\"line\">        success: function(msg)&#123;</span><br><span class=\"line\">            console.log(msg)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        error: function(msg)&#123;</span><br><span class=\"line\">            console.log(msg)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function add()&#123;</span><br><span class=\"line\">    csrf = $(&apos;input[name=&quot;csrfmiddlewaretoken&quot;]&apos;).val()</span><br><span class=\"line\">    s_name = $(&apos;#s_name&apos;).val()</span><br><span class=\"line\">    s_tel = $(&apos;#s_tel&apos;).val()</span><br><span class=\"line\">    $.ajax(&#123;</span><br><span class=\"line\">        url: &apos;/stu/student/&apos;,</span><br><span class=\"line\">        type: &apos;POST&apos;,</span><br><span class=\"line\">        dataType: &apos;json&apos;,</span><br><span class=\"line\">        headers:&#123;&apos;X-CSRFToken&apos;: csrf&#125;,</span><br><span class=\"line\">        data:&#123;&apos;s_name&apos;:s_name, &apos;s_tel&apos;:s_tel&#125;,</span><br><span class=\"line\">        success: function(msg)&#123;</span><br><span class=\"line\">            console.log(msg)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        error: function(msg)&#123;</span><br><span class=\"line\">            console.log(msg)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&#123;% csrf_token %&#125;</span><br><span class=\"line\">&lt;input id=&quot;showStus&quot; value=&quot;获取所有学生的信息&quot; type=&quot;button&quot;&gt;&lt;/input&gt;</span><br><span class=\"line\">&lt;div id=&quot;div_stus&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;div id=&quot;div_add&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">&lt;a href=&quot;javascript:;&quot; onclick=&quot;stu_add()&quot;&gt;添加&lt;/a&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"5-跨域请求\"><a href=\"#5-跨域请求\" class=\"headerlink\" title=\"5. 跨域请求\"></a>5. 跨域请求</h4><h5 id=\"5-1-什么是跨域\"><a href=\"#5-1-什么是跨域\" class=\"headerlink\" title=\"5.1 什么是跨域\"></a>5.1 什么是跨域</h5><p>同源：是指相同的协议、域名、端口，三者都相同才属于同源。</p>\n<p>同源策略：浏览器处于安全考虑，在全局层面禁止了页面加载或执行与自身来源不同的域的任何脚本，站外其他来源的脚本同页面的交互则被严格限制。</p>\n<p>跨域由于浏览器同源策略，凡是发送请求url的协议、域名、端口三者之间任意一与当前页面地址不同即为跨域</p>\n<h4 id=\"6-rest中的坑\"><a href=\"#6-rest中的坑\" class=\"headerlink\" title=\"6. rest中的坑\"></a>6. rest中的坑</h4><p>在实际的django项目中，我们经常需要使用到用户表，但是基于django提供的User表的字段有限，开发者一般都不会使用django提供的User模型，而自己创建User模型，并且基于登录注册的功能，也都会自己去实现，而不会使用django提供的登录注册功能。</p>\n<p>重点坑:在我们使用自定义的User模型进行用户的登录以及注册的时候，我们使用自定义的中间件进行对用户进行验证，如果验证通过了，就将当前登录的用户User对象绑定在request中，即request.user = user。这个时候坑就出现了，当我们使用restframework去写api接口的时候，会出现权限认证错误，如下提示：</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_keng1.png\" alt=\"图\"></p>\n<p>经过分析，可以判断是rest需要进行身份验证，所有我们在settings.py中设置rest的api接口不需要进行authentication的验证，具体配置如下：</p>\n<p><img src=\"/2018/05/18/在djnago当中restful风格的实现/C:/Users\\Administrator\\Desktop\\Desktop\\blog\\source\\_posts\\django_rest_setting_keng1.png\" alt=\"图\"></p>\n","categories":[{"name":"django","slug":"django","count":1,"path":"api/categories/django.json"}],"tags":[{"name":"Restful,django","slug":"Restful-django","count":1,"path":"api/tags/Restful-django.json"}]}